<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GenAI Prompt Feedback POC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
      body { @apply bg-gray-50 text-gray-800; font-family: 'Inter', sans-serif; }
      textarea { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
      .fade-in { animation: fade-in 0.3s ease-out; }
      @keyframes fade-in { from { opacity:0; transform: translateY(4px);} to { opacity:1; transform: translateY(0);} }
      h1, h2, h3, h4, h5, h6, .font-bold, .font-semibold, .text-3xl, .text-4xl, .font-bold, .font-semibold {
        font-family: 'Inter', sans-serif;
        font-weight: 600;
      }
    </style>
  </head>
  <body class="min-h-screen flex flex-col">
    <div id="root" class="flex-1"></div>

    <script type="text/babel">
      // ---------------------------
      // Helper Functions
      // ---------------------------
      
      // Helper to format evaluation JSON into user-friendly format
      function formatEvaluation(notesText) {
        try {
          const evalObj = JSON.parse(notesText);
          
          // Check if all components are present
          const allPresent = evalObj.task === "present" && 
                           evalObj.input === "present" && 
                           evalObj.steps === "present" && 
                           evalObj.output === "present";
          
          let result = allPresent ? "Amazing job! üéâ\n\n" : "Let's try again! ü§ì\n\n";
          
          // Format each component with icon and explanation
          const formatComponent = (name, status, explanation) => {
            const icon = status === "present" ? "‚úÖ" : status === "improvement" ? "‚ö†Ô∏è" : "‚ùå";
            const statusText = status === "present" ? "Present" : 
                             status === "improvement" ? "Needs Improvement" : "Missing";
            return `${icon} ${name} (${statusText}): ${explanation}`;
          };
          
          result += formatComponent("Task", evalObj.task, evalObj.taskExplanation) + "\n\n";
          result += formatComponent("Input", evalObj.input, evalObj.inputExplanation) + "\n\n";  
          result += formatComponent("Steps", evalObj.steps, evalObj.stepsExplanation) + "\n\n";
          result += formatComponent("Output", evalObj.output, evalObj.outputExplanation);
          
          // Add highlights if all components are present
          if (allPresent && evalObj.highlights) {
            result += "\n\nüåü Highlights: " + evalObj.highlights;
          }
          
          return result;
        } catch (e) {
          // If it's not JSON, return the original text
          return notesText;
        }
      }

      // ---------------------------
      // Authentication Functions
      // ---------------------------
      
      async function checkAuthStatus() {
        try {
          const res = await fetch('/api/auth-status');
          const data = await res.json();
          return data;
        } catch (err) {
          console.error('Error checking auth status:', err);
          return { authenticated: false, isAdmin: false };
        }
      }

      async function login(password) {
        try {
          const res = await fetch('/api/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password })
          });
          const data = await res.json();
          return data;
        } catch (err) {
          console.error('Login error:', err);
          return { error: 'Login failed' };
        }
      }

      // ---------------------------
      // OpenAI Evaluator Function
      // ---------------------------

      async function evaluatePrompt(prompt) {
        // System instructions for the evaluator
        const systemInstructions = `
SYSTEM PROMPT: Prompt Structure Reviewer

You are a prompt-structure reviewer. Your job is to check whether the input prompt contains the four key building blocks of a well-structured prompt:

üìå Prompt Structure Components

Task ‚Äì Define what you want the AI to accomplish
Best Practices:

Start with an action verb: write, create, analyze, develop

Be specific about the type of deliverable and target audience

Avoid vague phrases like ‚Äúhelp me with‚Äù or ‚Äúsomething about‚Äù

‚úÖ Example: ‚ÄúWrite a 500-word blog post for small business owners about cybersecurity best practices‚Äù
‚ùå Example: ‚ÄúHelp me with cybersecurity stuff for businesses‚Äù

Input ‚Äì Supply the raw materials or context the AI should use
Best Practices:

Provide specific sources, data, or background context

Instruct the AI to cite and quote from provided materials

Set strict boundaries: ‚ÄúSay ‚ÄòI don‚Äôt know‚Äô if info isn‚Äôt available‚Äù

Include 2‚Äì3 examples for complex or patterned tasks

‚úÖ Example instruction: ‚ÄúUse only the attached report. Do not add outside information.‚Äù
‚úÖ Example instruction: ‚ÄúPlease quote from the user feedback below where relevant.‚Äù

Steps ‚Äì Define a logical flow or process for the AI to follow
Best Practices:

Ensure there is a clear sequence or progression of actions, even if not formatted as a list

Look for signals of process or stage-based reasoning (e.g. ‚ÄúFirst‚Ä¶ then‚Ä¶ finally‚Ä¶‚Äù)

Include decision points or clarifications if needed

Avoid prompts that leap directly to the output without guiding how to get there

‚úÖ Example (structured):
Ask clarifying questions about audience and tone
Create an outline with 3‚Äì5 main points
Draft a first version using the provided style guide

‚úÖ Example (narrative form):
‚ÄúUsing the product feedback below, summarize the key themes, then write a follow-up message addressing them.‚Äù

Output ‚Äì Clarify the desired formatting and tone
Best Practices:

Describe the output format: paragraph, list, table, JSON, etc.

Specify the tone: professional, concise, casual, persuasive, etc.

Omit structural/layout expectations unless they are essential to the formatting

‚úÖ Example: ‚ÄúRespond in 3 bullet points using a friendly, informal tone‚Äù
‚úÖ Example: ‚ÄúOutput should be a single JSON object with camelCase keys and a confident tone‚Äù
‚ùå Example: ‚ÄúJust explain it‚Äù (too vague)

üîç How to evaluate:

Read the prompt carefully.

For each component, decide whether it is Present or Missing.

Mark as Missing only if it is absent or too vague to guide the AI.

If a component is Missing but the prompt includes a relevant example, include it as:

‚ÄúAn example is mentioned: [insert example].‚Äù

If a component is Present but weak or underspecified, suggest how to clarify it.

Focus on major structural gaps, not surface-level edits.

üìÑ Output format (follow this exact format):

If **any component is missing or underdefined**, return this **exact format**:

Let‚Äôs try again! ü§ì  

Task: [Missing ‚õî, Present but could use improvements üöß, or Present üåü. Include explanation. If an example is found, write: ‚ÄúAn example is mentioned: <example>.‚Äù]  
Input: [Same format]  
Steps: [Same format]  
Output: [Same format]

If **all four components are Present**, return this **exact format**:

Amazing job! üéâ

Highlights: [Optional 1‚Äì2 phrase summary of strengths, e.g. ‚Äúwell-scoped inputs‚Äù, ‚Äúaction-oriented steps‚Äù, ‚Äúprecise output formatting‚Äù]

‚úçÔ∏è Style Guidelines
‚úÖ Always evaluate whatever the input is
‚úÖ Focus only on structure (not grammar, content quality, or prompt intent)
‚úÖ Include prompt examples only if they relate to a missing component
‚ùå Do NOT change the output format
‚ùå Do NOT rewrite or improve the prompt
‚ùå Do NOT ask the user follow-up questions
‚ùå Do NOT add speculative guidance outside the requested output format
‚úÖ Keep feedback tight, relevant, and focused on what matters for structure
        `;

        try {
          const res = await fetch('/api/evaluate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt, systemInstructions })
          });
          console.log(prompt, systemInstructions)
          if (!res.ok) {
            throw new Error(`API error: ${res.status} ${res.statusText}`);
          }
          const data = await res.json();
          return { notes: data.notes };
        } catch (err) {
          console.error('Error evaluating prompt:', err);
          return { notes: 'There was an error contacting the evaluation service.' };
        }
      }

      const isBlank = (s) => !s || s.trim().length === 0;
      // Call backend to generate Facilitator Feedback using OpenAI GPT-4o
      const generateFacilitatorFeedback = async (prompt, evaluation) => {
        const formattedInput = `Prompt:\n${prompt}\n\nEvaluation:\n${evaluation}`;
        const systemInstructions = `
Your task is to generate structured support content to help the facilitator guide the participant toward a better prompt.

Inputs:
Prompt:
Evaluation:

Your output must follow this format:

Task Summary:
Summarize what the participant is trying to achieve based on their prompt. Use the evaluation only to clarify what‚Äôs missing or unclear‚Äîdon‚Äôt just restate it. Write 1‚Äì2 objective sentences. If the task is unclear, say so.

Be use-case specific when possible: e.g., suggest uploading a file, clarifying audience, giving example inputs, or breaking the task into steps.

Mitigation Strategies:
List 1‚Äì5 specific, proactive strategies the participant can use to include missing components in future prompts. Focus on omissions‚Äîwhat they failed to specify, assume, or define‚Äînot just vague improvements. These strategies should be forward-looking and generalizable.

Use bullet points. Avoid commenting on tone, phrasing, or optimization unless directly tied to a missing structural element.
        `;

        try {
          const res = await fetch('/api/facilitator-feedback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt, systemInstructions })
          });
          if (!res.ok) {
            throw new Error(`API error: ${res.status} ${res.statusText}`);
          }
          const data = await res.json();
          return data.feedback || '';
        } catch (err) {
          console.error('Error generating Facilitator Feedback:', err);
          return 'There was an error generating the facilitator feedback.';
        }
      };

      const sendToEvaluator = async ({ prompt }) => {
        const evaluationFeedback = await evaluatePrompt(prompt);
        const { notes } = evaluationFeedback;
        const facilitatorFeedback = await generateFacilitatorFeedback(prompt, evaluationFeedback.notes);
        return { notes, facilitatorFeedback };
      };

      // ---------------------------
      // React Component
      // ---------------------------
      function LoginForm({ onLogin }) {
        const [password, setPassword] = React.useState("");
        const [isLoading, setIsLoading] = React.useState(false);
        const [error, setError] = React.useState("");

        const handleSubmit = async (e) => {
          e.preventDefault();
          if (!password.trim()) return;
          
          setIsLoading(true);
          setError("");
          
          const result = await login(password);
          if (result.success) {
            onLogin(result.workshopName);
          } else {
            setError(result.error || "Invalid or expired password");
          }
          setIsLoading(false);
        };

        return (
          <div className="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
            <div className="max-w-md w-full space-y-8">
              <div className="text-center">
                <img src="./resources/tm_logo.png" alt="Thinking Machines Logo" className="mx-auto h-32 w-auto mb-6" />
                <h2 className="text-3xl font-bold text-gray-900">Access Workshop</h2>
                <p className="mt-2 text-sm text-gray-600">Enter your workshop password to continue</p>
              </div>
              <form className="mt-8 space-y-6" onSubmit={handleSubmit}>
                <div>
                  <label htmlFor="password" className="block text-sm font-medium text-gray-700">Workshop Password</label>
                  <input
                    id="password"
                    type="password"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    className="mt-1 appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                    placeholder="Enter workshop password"
                    required
                    autoFocus
                  />
                </div>
                {error && (
                  <div className="text-red-600 text-sm">{error}</div>
                )}
                <div>
                  <button
                    type="submit"
                    disabled={isLoading || !password.trim()}
                    className={`group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white ${
                      isLoading || !password.trim() 
                        ? 'bg-gray-400 cursor-not-allowed' 
                        : 'bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500'
                    }`}
                  >
                    {isLoading ? 'Verifying...' : 'Enter Workshop'}
                  </button>
                </div>
              </form>
            </div>
          </div>
        );
      }

      function App() {
        const [authenticated, setAuthenticated] = React.useState(false);
        const [workshopName, setWorkshopName] = React.useState("");
        const [firstName, setFirstName] = React.useState("");
        const [lastName,  setLastName]  = React.useState("");
        const [prompt,    setPrompt]    = React.useState("");
        const [isSubmitting, setIsSubmitting] = React.useState(false);
        const [lastEval,  setLastEval]  = React.useState(null);
        const [isLoading, setIsLoading] = React.useState(true);

        // Check authentication status on mount
        React.useEffect(() => {
          checkAuthStatus().then(status => {
            setAuthenticated(status.authenticated);
            setWorkshopName(status.workshopName || "");
            setIsLoading(false);
          });
        }, []);

        const handleLogin = (workshop) => {
          setAuthenticated(true);
          setWorkshopName(workshop);
        };

        if (isLoading) {
          return (
            <div className="min-h-screen flex items-center justify-center">
              <div className="text-gray-600">Loading...</div>
            </div>
          );
        }

        if (!authenticated) {
          return <LoginForm onLogin={handleLogin} />;
        }

        const handleSubmit = async (e) => {
          e.preventDefault();
          if (isBlank(firstName) || isBlank(lastName)) return alert("First and last name cannot be blank.");
          if (!prompt.trim()) return;
          setIsSubmitting(true);

          const { notes, facilitatorFeedback } = await sendToEvaluator({ prompt });
          const ts = new Date().toISOString();
          const newRec = {
            id: crypto.randomUUID(),
            timestamp: ts,
            firstname: firstName.trim(),
            lastname: lastName.trim(),
            prompt: prompt,
            notes: notes,
            facilitatorfeedback: facilitatorFeedback
          };
          
          // Save to backend (using prompts table in PostgreSQL)
          try {
            await fetch('/api/record', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(newRec)
            });
          } catch (err) {
            alert('Failed to save record to server.');
          }
          
          setLastEval({ notes, ts });
          setPrompt(""); setFirstName(""); setLastName("");
          setIsSubmitting(false);
        };

        return (
          <div className="w-full pt-20 pb-12 px-4">
            <div className="flex items-start max-w-7xl mx-auto">
              <div className="flex-shrink-0 w-[160px] mr-8 flex justify-center">
                <img src="./resources/tm_logo.png" alt="Thinking Machines Logo" className="h-[160px] w-auto" />
              </div>

              <div className="flex-1 max-w-5xl mx-auto">
                <header className="mb-6 text-left">
                  <h1 className="text-4xl font-bold leading-tight mb-2">Thinking Machines Prompt Evaluator Test</h1>
                  {workshopName && (
                    <div className="text-lg text-blue-600 font-semibold mb-2">{workshopName}</div>
                  )}
                  <span className="text-sm text-gray-500 hidden sm:inline">Beta testing</span>
                  <p className="text-gray-600 mt-2">Quickly score &amp; review prompts during enablement sessions.</p>
                </header>

                <section className="mb-10">
                  <form onSubmit={handleSubmit} className="bg-white shadow rounded-lg p-10 space-y-8">
                    <div>
                      <label className="block text-sm font-medium mb-1">First Name <span className="text-red-600">*</span></label>
                      <input type="text" className="w-full border rounded px-5 py-3" value={firstName} onChange={e => setFirstName(e.target.value)} placeholder="e.g., Alice" required />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Last Name <span className="text-red-600">*</span></label>
                      <input type="text" className="w-full border rounded px-5 py-3" value={lastName} onChange={e => setLastName(e.target.value)} placeholder="e.g., Garcia" required />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Prompt <span className="text-red-600">*</span></label>
                      <textarea className="w-full border rounded px-5 py-3 h-40" value={prompt} onChange={e => setPrompt(e.target.value)} placeholder="Paste your prompt here to check against prompt writing best practices" required />
                    </div>
                    <div className="flex items-center gap-4">
                      <button type="submit" disabled={isSubmitting || !prompt.trim()} className={`px-7 py-3 rounded text-white ${isSubmitting || !prompt.trim() ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'}`}>{isSubmitting ? 'Evaluating‚Ä¶' : 'Submit'}</button>
                      <span className="ml-auto text-sm text-gray-500 hidden sm:inline">Stored on PostgreSQL</span>
                    </div>
                  </form>

                  {lastEval && (
                    <div className="mt-10 bg-white border-l-4 border-blue-500 shadow rounded-lg p-8 fade-in">
                      <h3 className="font-semibold mb-2 text-base">Evaluation Feedback <span className="text-gray-500">({new Date(lastEval.ts).toLocaleString()})</span></h3>
                      <p className="whitespace-pre-wrap break-words text-sm">{formatEvaluation(lastEval.notes)}</p>
                    </div>
                  )}

                  {/* Facilitator Feedback is not shown to the user */}
                </section>

                <footer className="mt-20 text-xs text-gray-400 text-center">
                  <p>POC only ‚Äì using live OpenAI API evaluation. Store your API key securely.</p>
                </footer>
              </div>

              <div className="flex-shrink-0 w-[160px] ml-8"></div>
            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>
