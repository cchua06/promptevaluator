<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GenAI Prompt Feedback – Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
      body { @apply bg-gray-50 text-gray-800; font-family: 'Inter', sans-serif; }
      .fade-in { animation: fade-in 0.25s ease-out; }
      @keyframes fade-in { from { opacity:0; transform: translateY(4px);} to { opacity:1; transform: translateY(0);} }
      h1, h2, h3, h4, h5, h6, .font-bold, .font-semibold, .text-3xl, .text-4xl, .font-bold, .font-semibold {
        font-family: 'Inter', sans-serif;
        font-weight: 600;
      }
    </style>
  </head>
  <body class="min-h-screen flex flex-col">
    <div id="root" class="flex-1"></div>

    <script type="text/babel">

      // ---------------------------
      // Config – keep in sync with server env vars
      // ---------------------------
      const CLIENT_ADMIN_PASS = ''; // For POC only – store securely in prod!

      // ---------------------------
      // Authentication Functions
      // ---------------------------
      
      async function checkAuthStatus() {
        try {
          const res = await fetch('/api/auth-status');
          const data = await res.json();
          return data;
        } catch (err) {
          console.error('Error checking auth status:', err);
          return { authenticated: false, isAdmin: false };
        }
      }

      async function adminLogin(password) {
        try {
          const res = await fetch('/api/admin-login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password })
          });
          const data = await res.json();
          return data;
        } catch (err) {
          console.error('Admin login error:', err);
          return { error: 'Login failed' };
        }
      }

      // Column width config (Tailwind classes)
      const COL_WIDTHS = {
        timestamp: 'max-w-xs w-28',
        workshop: 'max-w-xs w-32',
        firstname: 'max-w-xs w-24',
        lastname: 'max-w-xs w-24',
        prompt: 'w-[12rem]',
        passfail: 'max-w-xs w-20',
        eval: 'min-w-[16rem]',
        facilitator: 'min-w-[16rem]',
        actions: '',
      };

      // ---------------------------
      // Helpers
      // ---------------------------

      // Data helpers
      async function fetchRecords() {
        const res = await fetch('/api/records');
        return res.json();
      }
      async function deleteRecord(id) {
        await fetch(`/api/record/${id}`, { method: 'DELETE' });
      }
      async function updateRecord(id, rec) {
        await fetch(`/api/record/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(rec)
        });
      }

      // Password management helpers
      async function fetchPasswords() {
        const res = await fetch('/api/passwords');
        return res.json();
      }
      async function deletePassword(id) {
        await fetch(`/api/password/${id}`, { method: 'DELETE' });
      }
      async function createPassword(workshopName, expiryDate) {
        const res = await fetch('/api/password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ workshopName, expiryDate })
        });
        return res.json();
      }
      // CSV export helper
      const csvEscape = v => `"${String(v ?? '').replaceAll('"', '""')}"`;
      function exportCSV(records) {
        const header = ['timestamp','workshop_name','firstname','lastname','prompt','notes','facilitatorfeedback']
          .map(csvEscape).join(',');
        const rows = records.map(r => [
          r.timestamp,
          r.workshop_name ?? '',
          r.firstname ?? '',
          r.lastname ?? '',
          r.prompt,
          r.notes,
          r.facilitatorfeedback
        ].map(csvEscape).join(',')).join('\n');
        const blob = new Blob([header+'\n'+rows], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = Object.assign(document.createElement('a'), { href:url, download:`prompt_records_${new Date().toISOString().slice(0,10)}.csv` });
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }

      function adjustDate(timestamp) {
        const d = new Date(timestamp);
        // Format: YYYY-MM-DD HH:MM (no seconds)
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,'0');
        const day = String(d.getDate()).padStart(2,'0');
        const hr = String(d.getHours()).padStart(2,'0');
        const min = String(d.getMinutes()).padStart(2,'0');
        return `${y}-${m}-${day} ${hr}:${min}`;
      }

      function formatShortDate(timestamp) {
        const d = new Date(timestamp);
        const day = String(d.getDate()).padStart(2,'0');
        const month = String(d.getMonth()+1).padStart(2,'0');
        const year = d.getFullYear();
        return `${day}/${month}/${year}`;
      }

      function generateRandomPassword() {
        let result = '';
        for (let i = 0; i < 6; i++) {
          result += Math.floor(Math.random() * 10).toString();
        }
        return result;
      }

      // ---------------------------
      // Components
      // ---------------------------
      
      function PasswordManager({ onClose }) {
        const [passwords, setPasswords] = React.useState([]);
        const [loading, setLoading] = React.useState(true);

        React.useEffect(() => {
          loadPasswords();
        }, []);

        const loadPasswords = async () => {
          setLoading(true);
          try {
            const data = await fetchPasswords();
            setPasswords(data);
          } catch (err) {
            console.error('Failed to load passwords:', err);
          }
          setLoading(false);
        };

        const handleDelete = async (id) => {
          if (confirm('Are you sure you want to delete this password?')) {
            try {
              await deletePassword(id);
              setPasswords(passwords.filter(p => p.id !== id));
            } catch (err) {
              alert('Failed to delete password');
            }
          }
        };

        return (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div className="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[80vh] overflow-y-auto">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-xl font-bold">Manage Passwords</h2>
                <button onClick={onClose} className="text-gray-500 hover:text-gray-700">✕</button>
              </div>
              
              {loading ? (
                <div className="text-center py-4">Loading...</div>
              ) : (
                <div className="space-y-3">
                  {passwords.length === 0 ? (
                    <div className="text-gray-500 text-center py-4">No passwords found</div>
                  ) : (
                    passwords.map(password => (
                      <div key={password.id} className="border rounded p-4 flex justify-between items-start">
                        <div>
                          <div><strong>Workshop Name:</strong> {password.workshop_name}</div>
                          <div><strong>Password:</strong> {password.id}</div>
                          <div><strong>Date of Expiry:</strong> {formatShortDate(password.date_of_expiry)}</div>
                        </div>
                        <button 
                          onClick={() => handleDelete(password.id)}
                          className="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm"
                        >
                          Delete
                        </button>
                      </div>
                    ))
                  )}
                </div>
              )}
            </div>
          </div>
        );
      }

      function GeneratePassword({ onClose }) {
        const [workshopName, setWorkshopName] = React.useState('');
        const [expiryDate, setExpiryDate] = React.useState('');
        const [generatedPassword, setGeneratedPassword] = React.useState(null);
        const [loading, setLoading] = React.useState(false);

        const handleSubmit = async (e) => {
          e.preventDefault();
          if (!workshopName.trim() || !expiryDate) return;
          
          setLoading(true);
          try {
            const result = await createPassword(workshopName.trim(), expiryDate);
            setGeneratedPassword(result);
          } catch (err) {
            alert('Failed to generate password');
          }
          setLoading(false);
        };

        const handleClose = () => {
          setGeneratedPassword(null);
          onClose();
        };

        if (generatedPassword) {
          return (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div className="bg-white rounded-lg p-6 w-full max-w-md">
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-bold">Password Generated</h2>
                  <button onClick={handleClose} className="text-gray-500 hover:text-gray-700">✕</button>
                </div>
                
                <div className="space-y-2 mb-6">
                  <div><strong>Workshop Name:</strong> {generatedPassword.workshop_name}</div>
                  <div><strong>Password:</strong> <span className="font-bold text-lg">{generatedPassword.password}</span></div>
                  <div><strong>Date of Expiry:</strong> {formatShortDate(generatedPassword.date_of_expiry)}</div>
                </div>
                
                <button 
                  onClick={handleClose}
                  className="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded"
                >
                  Close
                </button>
              </div>
            </div>
          );
        }

        return (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div className="bg-white rounded-lg p-6 w-full max-w-md">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-xl font-bold">Generate Password</h2>
                <button onClick={onClose} className="text-gray-500 hover:text-gray-700">✕</button>
              </div>
              
              <form onSubmit={handleSubmit} className="space-y-4">
                <div>
                  <label className="block text-sm font-medium mb-1">Workshop Name:</label>
                  <input 
                    type="text" 
                    value={workshopName}
                    onChange={(e) => setWorkshopName(e.target.value)}
                    className="w-full border rounded px-3 py-2"
                    placeholder="e.g., AI Fundamentals Workshop"
                    required
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium mb-1">Date of Expiry:</label>
                  <input 
                    type="datetime-local" 
                    value={expiryDate}
                    onChange={(e) => setExpiryDate(e.target.value)}
                    className="w-full border rounded px-3 py-2"
                    required
                  />
                </div>
                
                <div className="flex gap-2">
                  <button 
                    type="submit"
                    disabled={loading || !workshopName.trim() || !expiryDate}
                    className={`flex-1 py-2 rounded text-white ${
                      loading || !workshopName.trim() || !expiryDate
                        ? 'bg-gray-400 cursor-not-allowed' 
                        : 'bg-green-600 hover:bg-green-700'
                    }`}
                  >
                    {loading ? 'Generating...' : 'Generate Password'}
                  </button>
                  <button 
                    type="button"
                    onClick={onClose}
                    className="px-4 py-2 border rounded hover:bg-gray-50"
                  >
                    Cancel
                  </button>
                </div>
              </form>
            </div>
          </div>
        );
      }

      function AdminApp() {
        const [records, setRecords] = React.useState([]);
        const [editingId, setEditingId] = React.useState(null);
        const [editRec, setEditRec] = React.useState({});
        const [showPasswordManager, setShowPasswordManager] = React.useState(false);
        const [showGeneratePassword, setShowGeneratePassword] = React.useState(false);

        // On mount, load records from PostgreSQL
        React.useEffect(() => {
          load();
        }, []);

        const load = async () => setRecords(await fetchRecords());

        const handleDelete = async id => {
          await deleteRecord(id);
          setRecords(records => records.filter(r => r.id !== id));
        };
        const handleRefresh = load;

        const handleEdit = rec => {
          setEditingId(rec.id);
          setEditRec({ ...rec });
        };
        const handleEditChange = (field, value) => setEditRec(r => ({ ...r, [field]: value }));
        const handleEditSave = async () => {
          await updateRecord(editingId, editRec);
          setEditingId(null);
          load();
        };
        const handleEditCancel = () => setEditingId(null);

        return (
          <div className="mx-auto py-10 px-2" style={{ width: '95%' }}>
            <header className="mb-8 flex items-center gap-3 flex-wrap">
              <h1 className="text-3xl font-bold mr-auto">Prompt Submissions – Admin</h1>
              <button
                onClick={() => setShowPasswordManager(true)}
                className="px-4 py-2 rounded border hover:bg-gray-100 text-sm"
                title="View and manage workshop passwords"
              >
                Manage Passwords
              </button>
              <button
                onClick={() => setShowGeneratePassword(true)}
                className="px-4 py-2 rounded bg-green-600 hover:bg-green-700 text-white text-sm"
                title="Generate new workshop password"
              >
                Generate Password
              </button>
              <button
                onClick={handleRefresh}
                className="px-4 py-2 rounded border hover:bg-gray-100 text-sm"
                title="Reload records from server"
              >
                Refresh
              </button>
              <button
                onClick={() => exportCSV(records)}
                className="px-4 py-2 rounded border hover:bg-gray-100 text-sm"
              >
                Export CSV
              </button>
            </header>

            <section>
              <div className="overflow-x-auto">
                <table className="w-full bg-white shadow rounded-lg overflow-hidden">
                  <thead className="bg-gray-100 text-sm">
                    <tr>
                      <th className={`px-2 py-2 text-left ${COL_WIDTHS.timestamp}`}>Timestamp</th>
                      <th className={`px-2 py-2 text-left ${COL_WIDTHS.workshop}`}>Workshop</th>
                      <th className={`px-2 py-2 text-left ${COL_WIDTHS.firstname}`}>First Name</th>
                      <th className={`px-2 py-2 text-left ${COL_WIDTHS.lastname}`}>Last Name</th>
                      <th className={`px-2 py-2 text-left ${COL_WIDTHS.prompt}`}>Prompt</th>
                      <th className={`px-2 py-2 text-left ${COL_WIDTHS.passfail}`}>Pass/Fail</th>
                      <th className={`px-2 py-2 text-left ${COL_WIDTHS.eval}`}>Evaluation Feedback</th>
                      <th className={`px-2 py-2 text-left ${COL_WIDTHS.facilitator}`}>Facilitator Feedback</th>
                      <th className={`px-2 py-2 ${COL_WIDTHS.actions}`}></th>
                    </tr>
                  </thead>
                  <tbody className="text-sm">
                    {records.map(r => editingId === r.id ? (
                      <tr key={r.id} className="border-t bg-yellow-50 fade-in">
                        <td className={`px-2 py-2 align-top whitespace-nowrap ${COL_WIDTHS.timestamp}`}> 
                          {adjustDate(r.timestamp)}                    
                        </td>
                        <td className={`px-2 py-2 align-top whitespace-nowrap ${COL_WIDTHS.workshop}`}> 
                          {r.workshop_name || '—'}
                        </td>
                        <td className={`px-2 py-2 align-top whitespace-nowrap ${COL_WIDTHS.firstname}`}> 
                          <input value={editRec.firstname} onChange={e => handleEditChange('firstname', e.target.value)} className="border rounded px-2 py-1 w-24" />
                        </td>
                        <td className={`px-2 py-2 align-top whitespace-nowrap ${COL_WIDTHS.lastname}`}> 
                          <input value={editRec.lastname} onChange={e => handleEditChange('lastname', e.target.value)} className="border rounded px-2 py-1 w-24" />
                        </td>
                        <td className={`px-2 py-2 align-top ${COL_WIDTHS.prompt}`}> 
                          <textarea value={editRec.prompt} onChange={e => handleEditChange('prompt', e.target.value)} className={`border rounded px-2 py-1 ${COL_WIDTHS.prompt}`} />
                        </td>
                        <td className={`px-2 py-2 align-top whitespace-nowrap font-semibold ${COL_WIDTHS.passfail}`}> 
                          {(() => {
                            const val = (editRec.notes || '').trim();
                          const failRe = /^Let['’]s try again!?/;
                            return failRe.test(val) ? (
                              <span className="text-red-600">Fail</span>
                            ) : (
                              <span className="text-green-700">Pass</span>
                            );
                          })()}
                        </td>
                        <td className={`px-2 py-2 align-top ${COL_WIDTHS.eval}`}> 
                          <textarea value={editRec.notes} onChange={e => handleEditChange('notes', e.target.value)} className={`border rounded px-2 py-1 w-full ${COL_WIDTHS.eval}`} />
                        </td>
                        <td className={`px-2 py-2 align-top ${COL_WIDTHS.facilitator}`}> 
                          <textarea value={editRec.facilitatorfeedback} onChange={e => handleEditChange('facilitatorfeedback', e.target.value)} className={`border rounded px-2 py-1 w-full ${COL_WIDTHS.facilitator}`} />
                        </td>
                        <td className={`px-2 py-2 align-top text-center ${COL_WIDTHS.actions}`}> 
                          <button onClick={handleEditSave} className="text-green-600 hover:underline text-xs mr-2">Save</button>
                          <button onClick={handleEditCancel} className="text-gray-600 hover:underline text-xs">Cancel</button>
                        </td>
                      </tr>
                    ) : (
                      <tr key={r.id} className="border-t hover:bg-gray-50 fade-in">
                        <td className={`px-2 py-2 align-top whitespace-nowrap ${COL_WIDTHS.timestamp}`}> 
                          {adjustDate(r.timestamp)}
                        </td>
                        <td className={`px-2 py-2 align-top whitespace-nowrap ${COL_WIDTHS.workshop}`}>
                          {r.workshop_name}
                        </td>
                        <td className={`px-2 py-2 align-top whitespace-nowrap ${COL_WIDTHS.firstname}`}>{r.firstname || '—'}</td>
                        <td className={`px-2 py-2 align-top whitespace-nowrap ${COL_WIDTHS.lastname}`}>{r.lastname || '—'}</td>
                        <td className={`px-2 py-2 align-top ${COL_WIDTHS.prompt}`}> 
                          <pre className={`whitespace-pre-wrap break-words ${COL_WIDTHS.prompt}`}>{r.prompt}</pre>
                        </td>
                        <td className={`px-2 py-2 align-top whitespace-nowrap font-semibold ${COL_WIDTHS.passfail}`}> 
                          {(() => {
                            const val = (r.notes || '').trim();
                            const failRe = /^Let['’]s try again!?/;
                            return failRe.test(val) ? (
                              <span className="text-red-600">Fail</span>
                            ) : (
                              <span className="text-green-700">Pass</span>
                            );
                          })()}
                        </td>
                        <td className={`px-2 py-2 align-top ${COL_WIDTHS.eval}`}> 
                          <pre className={`whitespace-pre-wrap break-words ${COL_WIDTHS.eval}`}>{r.notes}</pre>
                        </td>
                        <td className={`px-2 py-2 align-top ${COL_WIDTHS.facilitator}`}> 
                          <pre className={`whitespace-pre-wrap break-words ${COL_WIDTHS.facilitator}`}>{r.facilitatorfeedback}</pre>
                        </td>
                        <td className={`px-2 py-2 align-top text-center ${COL_WIDTHS.actions}`}> 
                          <button onClick={() => handleEdit(r)} className="text-blue-600 hover:underline text-xs mr-2">Edit</button>
                          <br></br>
                          <button onClick={() => handleDelete(r.id)} className="text-red-600 hover:underline text-xs">Delete</button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </section>

            <footer className="mt-12 text-xs text-gray-400 text-center">
              <p>Data is stored in a PostgreSQL database.</p>
            </footer>
            
            {showPasswordManager && (
              <PasswordManager onClose={() => setShowPasswordManager(false)} />
            )}
            
            {showGeneratePassword && (
              <GeneratePassword onClose={() => setShowGeneratePassword(false)} />
            )}
          </div>
        );
      }

      function Gatekeeper() {
        const [pw, setPw] = React.useState('');
        const [isAdmin, setIsAdmin] = React.useState(false);
        const [err, setErr] = React.useState(false);
        const [isLoading, setIsLoading] = React.useState(true);

        // Check authentication status on mount
        React.useEffect(() => {
          checkAuthStatus().then(status => {
            setIsAdmin(status.isAdmin);
            setIsLoading(false);
          });
        }, []);

        const submit = async (e) => {
          e.preventDefault();
          const result = await adminLogin(pw);
          if (result.success) {
            setIsAdmin(true);
          } else {
            setErr(true);
            setPw('');
          }
        };

        if (isLoading) {
          return (
            <div className="flex items-center justify-center h-screen">
              <div className="text-gray-600">Loading...</div>
            </div>
          );
        }

        if (isAdmin) return <AdminApp />;

        return (
          <div className="flex flex-col items-center justify-center h-screen gap-4">
            <form onSubmit={submit} className="bg-white shadow rounded-lg p-6 w-80 space-y-4">
              <h2 className="text-lg font-semibold text-center">Admin Login</h2>
              <input
                type="password"
                placeholder="Admin Password"
                className="w-full border rounded px-3 py-2"
                value={pw}
                onChange={e => setPw(e.target.value)}
                autoFocus
              />
              {err && <p className="text-red-600 text-sm">Incorrect password.</p>}
              <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white rounded px-3 py-2">Enter</button>
            </form>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<Gatekeeper />);
    </script>
  </body>
</html>