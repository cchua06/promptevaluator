name: Deploy to GCP VM

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate with Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Setup Google Cloud CLI
      uses: google-github-actions/setup-gcloud@v2

    - name: Set project from Secret Manager
      run: |
        gcloud config set project $(gcloud secrets versions access latest --secret="GCP_PROJECT_ID")

    - name: Upload code to VM
      run: |
        gcloud compute ssh $(gcloud secrets versions access latest --secret="VM_INSTANCE_NAME") --zone=$(gcloud secrets versions access latest --secret="VM_ZONE") --command="cd ~ && rm -rf promptevaluator"
        gcloud compute scp --recurse . $(gcloud secrets versions access latest --secret="VM_INSTANCE_NAME"):~/promptevaluator --zone=$(gcloud secrets versions access latest --secret="VM_ZONE")

    - name: Stop containers
      run: |
        gcloud compute ssh $(gcloud secrets versions access latest --secret="VM_INSTANCE_NAME") --zone=$(gcloud secrets versions access latest --secret="VM_ZONE") --command="cd ~/promptevaluator && docker-compose down"

    - name: Start containers with secrets
      run: |
        gcloud compute ssh $(gcloud secrets versions access latest --secret="VM_INSTANCE_NAME") --zone=$(gcloud secrets versions access latest --secret="VM_ZONE") --command="cd ~/promptevaluator && OPENAI_API_KEY=$(gcloud secrets versions access latest --secret="OPENAI_API_KEY") PGPASSWORD=$(gcloud secrets versions access latest --secret="CLOUDSQL_PASSWORD") docker-compose up -d --build"

    - name: Check container status
      run: |
        gcloud compute ssh $(gcloud secrets versions access latest --secret="VM_INSTANCE_NAME") --zone=$(gcloud secrets versions access latest --secret="VM_ZONE") --command="cd ~/promptevaluator && docker-compose ps"

    - name: Restart Cloudflare tunnel
      run: |
        gcloud compute ssh $(gcloud secrets versions access latest --secret="VM_INSTANCE_NAME") --zone=$(gcloud secrets versions access latest --secret="VM_ZONE") --command="docker stop cloudflare-tunnel 2>/dev/null || true && docker rm cloudflare-tunnel 2>/dev/null || true && docker run -d --network host --name cloudflare-tunnel cloudflare/cloudflared:latest tunnel --no-autoupdate run --token $(gcloud secrets versions access latest --secret="CLOUDFLARE_TUNNEL_TOKEN")"

    - name: Health check
      run: |
        sleep 30  # Wait for application to start
        gcloud compute ssh $(gcloud secrets versions access latest --secret="VM_INSTANCE_NAME") --zone=$(gcloud secrets versions access latest --secret="VM_ZONE") --command="cd ~/promptevaluator && docker-compose ps && docker-compose logs --tail=20"

    - name: Deployment status
      run: |
        echo "ğŸš€ Deployment completed!"
        echo "ğŸ“Š Application URL: https://prompt-checker.tm8.dev"
        echo "ğŸ”§ VM Instance: $(gcloud secrets versions access latest --secret="VM_INSTANCE_NAME")"
        echo "ğŸ“ Commit: ${{ github.sha }}"