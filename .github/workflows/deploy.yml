name: Deploy to GCP VM

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Google Cloud CLI
      uses: google-github-actions/setup-gcloud@v2
      with:
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    - name: Configure Docker for Artifact Registry
      run: |
        gcloud auth configure-docker us-central1-docker.pkg.dev

    - name: Build and push Docker image
      run: |
        docker build -t us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/prompt-evaluator-artifact-repository/prompt-evaluator:${{ github.sha }} .
        docker push us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/prompt-evaluator-artifact-repository/prompt-evaluator:${{ github.sha }}
        # Also tag as latest
        docker tag us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/prompt-evaluator-artifact-repository/prompt-evaluator:${{ github.sha }} us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/prompt-evaluator-artifact-repository/prompt-evaluator:latest
        docker push us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/prompt-evaluator-artifact-repository/prompt-evaluator:latest

    - name: Create environment file
      run: |
        cat > .env << EOF
        OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
        PGHOST=localhost
        PGUSER=postgres
        PGPASSWORD=${{ secrets.CLOUDSQL_PASSWORD }}
        PGDATABASE=prompt-evaluator-db
        PGPORT=5432
        EOF

    - name: Upload environment file to VM
      run: |
        gcloud compute scp .env luis@${{ secrets.VM_INSTANCE_NAME }}:~/promptevaluator/ --zone=${{ secrets.VM_ZONE }}

    - name: Deploy application
      run: |
        gcloud compute ssh luis@${{ secrets.VM_INSTANCE_NAME }} --zone=${{ secrets.VM_ZONE }} --command="
          cd ~/promptevaluator
          docker-compose down
          docker pull us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/prompt-evaluator-artifact-repository/prompt-evaluator:latest
          docker-compose up -d
          docker-compose ps
        "

    - name: Restart Cloudflare tunnel
      run: |
        gcloud compute ssh luis@${{ secrets.VM_INSTANCE_NAME }} --zone=${{ secrets.VM_ZONE }} --command="
          docker stop cloudflare-tunnel 2>/dev/null || true
          docker rm cloudflare-tunnel 2>/dev/null || true
          docker run -d --network host --name cloudflare-tunnel cloudflare/cloudflared:latest tunnel --no-autoupdate run --token ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
        "

    - name: Health check
      run: |
        sleep 30  # Wait for application to start
        gcloud compute ssh luis@${{ secrets.VM_INSTANCE_NAME }} --zone=${{ secrets.VM_ZONE }} --command="
          cd ~/promptevaluator
          docker-compose ps
          docker-compose logs --tail=20
        "

    - name: Deployment status
      run: |
        echo "ğŸš€ Deployment completed!"
        echo "ğŸ“Š Application URL: https://prompt-checker.tm8.dev"
        echo "ğŸ”§ VM Instance: ${{ secrets.VM_INSTANCE_NAME }}"
        echo "ğŸ“ Commit: ${{ github.sha }}" 